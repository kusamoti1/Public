<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="åº•å€¤ãƒ¡ãƒ¢">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>åº•å€¤ãƒ¡ãƒ¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface2: #252540;
      --surface3: #2e2e50;
      --accent: #e8c547;
      --accent2: #4fc3f7;
      --text: #e8e8f0;
      --text2: #9090b0;
      --text3: #5a5a80;
      --danger: #ff6b6b;
      --success: #69e08a;
      --radius: 14px;
      --radius-sm: 8px;
      --font: 'Noto Sans JP', sans-serif;
      --mono: 'DM Mono', monospace;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 100;
      background: var(--surface);
      border-bottom: 1px solid var(--surface3);
      padding: 12px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .header-title {
      flex: 1;
      font-size: 18px; font-weight: 700; letter-spacing: 0.02em;
    }
    .header-title span { color: var(--accent); }
    .count-badge {
      font-family: var(--mono);
      font-size: 12px; color: var(--text2);
      background: var(--surface2);
      padding: 3px 8px; border-radius: 20px;
    }

    /* Tab Nav */
    .tab-nav {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--surface3);
    }
    .tab-btn {
      flex: 1; padding: 10px 4px;
      font-family: var(--font); font-size: 13px; font-weight: 500;
      color: var(--text3); background: none; border: none;
      cursor: pointer; transition: color 0.2s;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* Main content */
    .main { padding: 16px 16px calc(16px + var(--safe-bottom)); max-width: 640px; margin: 0 auto; }

    /* Search bar */
    .search-bar {
      display: flex; gap: 8px; margin-bottom: 14px;
    }
    .search-input {
      flex: 1; padding: 10px 14px;
      background: var(--surface); border: 1px solid var(--surface3);
      border-radius: var(--radius-sm); color: var(--text);
      font-family: var(--font); font-size: 14px;
      outline: none; transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent2); }
    .search-input::placeholder { color: var(--text3); }

    /* Sort select */
    .sort-select {
      padding: 10px 12px;
      background: var(--surface); border: 1px solid var(--surface3);
      border-radius: var(--radius-sm); color: var(--text2);
      font-family: var(--font); font-size: 13px;
      outline: none; cursor: pointer;
    }

    /* Filter row */
    .filter-row {
      display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap;
    }
    .filter-chip {
      padding: 5px 12px; border-radius: 20px;
      background: var(--surface2); color: var(--text2);
      font-size: 12px; border: 1px solid var(--surface3);
      cursor: pointer; transition: all 0.15s;
      white-space: nowrap;
    }
    .filter-chip.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 700; }

    /* Item card */
    .item-card {
      background: var(--surface);
      border: 1px solid var(--surface3);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: border-color 0.15s, transform 0.1s;
      position: relative;
      overflow: hidden;
    }
    .item-card:active { transform: scale(0.98); }
    .item-card::before {
      content: '';
      position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
      background: var(--accent2); border-radius: 3px 0 0 3px;
    }
    .item-card.best-price::before { background: var(--success); }

    .card-top { display: flex; align-items: flex-start; gap: 10px; }
    .card-name { font-size: 15px; font-weight: 700; flex: 1; line-height: 1.3; }
    .card-price {
      font-family: var(--mono); font-size: 20px; font-weight: 500;
      color: var(--accent); white-space: nowrap;
    }
    .card-price-unit { font-size: 13px; color: var(--text2); }
    .card-bottom { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .tag {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 11px; color: var(--text2);
    }
    .tag-icon { font-size: 10px; }
    .best-label {
      font-size: 10px; font-weight: 700; letter-spacing: 0.05em;
      color: var(--success); background: rgba(105,224,138,0.12);
      padding: 2px 7px; border-radius: 10px;
    }

    /* Form */
    .form-card {
      background: var(--surface);
      border: 1px solid var(--surface3);
      border-radius: var(--radius);
      padding: 16px;
    }
    .form-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

    .form-group { margin-bottom: 14px; }
    .form-label { font-size: 12px; color: var(--text2); margin-bottom: 6px; display: block; font-weight: 500; letter-spacing: 0.05em; }
    .form-input {
      width: 100%; padding: 11px 14px;
      background: var(--surface2); border: 1px solid var(--surface3);
      border-radius: var(--radius-sm); color: var(--text);
      font-family: var(--font); font-size: 15px;
      outline: none; transition: border-color 0.2s;
    }
    .form-input:focus { border-color: var(--accent); }
    .form-input::placeholder { color: var(--text3); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .camera-input {
      width: 100%;
      padding: 10px;
      border: 1px dashed var(--surface3);
      border-radius: var(--radius-sm);
      background: var(--surface2);
      color: var(--text2);
    }
    .photo-preview-wrap { margin-top: 10px; }
    .photo-preview {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      border: 1px solid var(--surface3);
      display: block;
    }
    .photo-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text2);
      line-height: 1.5;
    }

    .btn {
      padding: 13px 20px; border-radius: var(--radius-sm);
      font-family: var(--font); font-size: 15px; font-weight: 700;
      border: none; cursor: pointer; transition: all 0.15s;
      width: 100%;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-secondary { background: var(--surface2); color: var(--text2); }
    .btn-danger { background: rgba(255,107,107,0.15); color: var(--danger); border: 1px solid rgba(255,107,107,0.3); }
    .btn-row { display: flex; gap: 8px; margin-top: 6px; }
    .btn-row .btn { flex: 1; }

    /* Modal/Detail overlay */
    .overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex; align-items: flex-end;
      opacity: 0; pointer-events: none; transition: opacity 0.25s;
    }
    .overlay.show { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--surface3);
      border-radius: var(--radius) var(--radius) 0 0;
      padding: 20px 16px calc(20px + var(--safe-bottom));
      width: 100%; max-width: 640px; margin: 0 auto;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    }
    .overlay.show .modal { transform: translateY(0); }
    .modal-handle { width: 36px; height: 4px; background: var(--surface3); border-radius: 2px; margin: 0 auto 16px; }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 16px; }
    .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--surface3); }
    .detail-label { font-size: 12px; color: var(--text2); }
    .detail-value { font-size: 15px; font-weight: 500; }
    .detail-price { font-family: var(--mono); font-size: 24px; font-weight: 500; color: var(--accent); }
    .detail-photo-wrap { margin-top: 12px; }
    .detail-photo {
      width: 100%;
      max-height: 240px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      border: 1px solid var(--surface3);
    }

    /* Toast */
    .toast {
      position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(80px);
      z-index: 300; background: var(--surface2); color: var(--text);
      padding: 10px 20px; border-radius: 30px;
      font-size: 13px; font-weight: 500;
      border: 1px solid var(--surface3);
      transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Empty state */
    .empty {
      text-align: center; padding: 60px 20px;
      color: var(--text3);
    }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-text { font-size: 14px; line-height: 1.6; }

    /* Export section */
    .export-card {
      background: var(--surface); border: 1px solid var(--surface3);
      border-radius: var(--radius); padding: 16px; margin-bottom: 14px;
    }
    .export-title { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
    .export-desc { font-size: 12px; color: var(--text2); margin-bottom: 12px; line-height: 1.6; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .stat-box { background: var(--surface2); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
    .stat-num { font-family: var(--mono); font-size: 22px; font-weight: 500; color: var(--accent); }
    .stat-label { font-size: 11px; color: var(--text2); margin-top: 2px; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-title">ğŸ’° <span>åº•å€¤</span>ãƒ¡ãƒ¢</div>
  <div class="count-badge" id="totalCount">0ä»¶</div>
</div>

<div class="tab-nav">
  <button class="tab-btn active" onclick="showTab('list')">ä¸€è¦§</button>
  <button class="tab-btn" onclick="showTab('add')">ç™»éŒ²</button>
  <button class="tab-btn" onclick="showTab('data')">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
</div>

<!-- ===== ä¸€è¦§ã‚¿ãƒ– ===== -->
<div id="tab-list" class="main">
  <div class="search-bar">
    <input class="search-input" id="searchInput" type="search" placeholder="å“åãƒ»åº—ã§æ¤œç´¢..." oninput="renderList()">
    <select class="sort-select" id="sortSelect" onchange="renderList()">
      <option value="date_desc">æ–°ã—ã„é †</option>
      <option value="date_asc">å¤ã„é †</option>
      <option value="price_asc">å®‰ã„é †</option>
      <option value="price_desc">é«˜ã„é †</option>
      <option value="name_asc">å“åé †</option>
    </select>
  </div>
  <div class="filter-row" id="shopFilters"></div>
  <div id="listContainer"></div>
</div>

<!-- ===== ç™»éŒ²ã‚¿ãƒ– ===== -->
<div id="tab-add" class="main hidden">
  <div class="form-card">
    <div class="form-title" id="formTitle">æ–°ã—ãç™»éŒ²ã™ã‚‹</div>
    <input type="hidden" id="editId">

    <div class="form-group">
      <label class="form-label">å“å *</label>
      <input class="form-input" id="fName" type="text" placeholder="ä¾‹ï¼šåµï¼ˆMã‚µã‚¤ã‚º10å€‹ï¼‰">
    </div>
    <div class="form-group">
      <label class="form-label">åº—å *</label>
      <input class="form-input" id="fShop" type="text" placeholder="ä¾‹ï¼šãƒ©ã‚¤ãƒ• æ¸‹è°·åº—" list="shopSuggestions">
      <datalist id="shopSuggestions"></datalist>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ä¾¡æ ¼ï¼ˆå††ï¼‰*</label>
        <input class="form-input" id="fPrice" type="number" placeholder="198" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">å˜ä½</label>
        <input class="form-input" id="fUnit" type="text" placeholder="ä¾‹ï¼š100g">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">æ—¥ä»˜ *</label>
      <input class="form-input" id="fDate" type="date">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¡ãƒ¢</label>
      <input class="form-input" id="fNote" type="text" placeholder="ä¾‹ï¼šç‰¹å£²ã€æ›œæ—¥é™å®šãªã©">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ¬ã‚·ãƒ¼ãƒˆ/å•†å“å†™çœŸï¼ˆä»»æ„ï¼‰</label>
      <input class="camera-input" id="fPhoto" type="file" accept="image/*" capture="environment" onchange="handlePhotoChange(event)">
      <div class="photo-preview-wrap hidden" id="photoPreviewWrap">
        <img id="photoPreview" class="photo-preview" alt="æ’®å½±ã—ãŸå†™çœŸã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        <button class="btn btn-secondary" style="margin-top:8px" onclick="clearPhoto()" type="button">å†™çœŸã‚’å‰Šé™¤</button>
      </div>
      <div class="photo-hint">iPhoneã§ã¯ã“ã®æ¬„ã‹ã‚‰ã‚«ãƒ¡ãƒ©èµ·å‹•ã—ã¦ã€ãã®ã¾ã¾ç™»éŒ²ã«ä½¿ãˆã¾ã™ã€‚</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="resetForm()">ã‚¯ãƒªã‚¢</button>
      <button class="btn btn-primary" onclick="saveItem()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ===== ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¿ãƒ– ===== -->
<div id="tab-data" class="main hidden">
  <div class="stats-grid">
    <div class="stat-box"><div class="stat-num" id="statItems">0</div><div class="stat-label">ç™»éŒ²ä»¶æ•°</div></div>
    <div class="stat-box"><div class="stat-num" id="statShops">0</div><div class="stat-label">åº—èˆ—æ•°</div></div>
  </div>
  <div class="export-card">
    <div class="export-title">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
    <div class="export-desc">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§æ›¸ãå‡ºã—ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ä»–ç«¯æœ«ã¸ã®ç§»è¡Œã«ä½¿ãˆã¾ã™ã€‚</div>
    <button class="btn btn-primary" onclick="exportData()">JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>
  <div class="export-card">
    <div class="export-title">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
    <div class="export-desc">ä»¥å‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">JSONã‚’èª­ã¿è¾¼ã‚€</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
  <div class="export-card">
    <div class="export-title" style="color:var(--danger)">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</div>
    <div class="export-desc">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</div>
    <button class="btn btn-danger" onclick="clearAll()">å…¨å‰Šé™¤ã™ã‚‹</button>
  </div>
</div>

<!-- ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="detailName"></div>
    <div class="detail-row">
      <span class="detail-label">ä¾¡æ ¼</span>
      <span class="detail-price" id="detailPrice"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">å˜ä½</span>
      <span class="detail-value" id="detailUnit"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">åº—å</span>
      <span class="detail-value" id="detailShop"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">æ—¥ä»˜</span>
      <span class="detail-value" id="detailDate"></span>
    </div>
    <div class="detail-row" id="detailNoteRow">
      <span class="detail-label">ãƒ¡ãƒ¢</span>
      <span class="detail-value" id="detailNote"></span>
    </div>
    <div class="detail-photo-wrap hidden" id="detailPhotoWrap">
      <img class="detail-photo" id="detailPhoto" alt="ç™»éŒ²ã—ãŸå†™çœŸ">
    </div>
    <div class="btn-row" style="margin-top:16px">
      <button class="btn btn-danger" onclick="deleteItem()">å‰Šé™¤</button>
      <button class="btn btn-primary" onclick="editItem()">ç·¨é›†</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== DATA =====
let items = JSON.parse(localStorage.getItem('nekodene_items') || '[]');
let currentId = null;
let activeShopFilter = '';

function save() {
  localStorage.setItem('nekodene_items', JSON.stringify(items));
  updateCount();
  updateStats();
}

function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function updateCount() {
  document.getElementById('totalCount').textContent = items.length + 'ä»¶';
}

function updateStats() {
  const shops = new Set(items.map(i => i.shop));
  document.getElementById('statItems').textContent = items.length;
  document.getElementById('statShops').textContent = shops.size;
}

// ===== TABS =====
function showTab(name) {
  ['list','add','data'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('hidden', t !== name);
  });
  document.querySelectorAll('.tab-btn').forEach((b,i) => {
    b.classList.toggle('active', ['list','add','data'][i] === name);
  });
  if (name === 'list') renderList();
  if (name === 'data') updateStats();
}

// ===== LIST =====
function renderList() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const sort = document.getElementById('sortSelect').value;
  
  let filtered = items.filter(i => {
    const matchQ = !q || i.name.toLowerCase().includes(q) || i.shop.toLowerCase().includes(q);
    const matchShop = !activeShopFilter || i.shop === activeShopFilter;
    return matchQ && matchShop;
  });

  filtered.sort((a,b) => {
    if (sort === 'date_desc') return new Date(b.date) - new Date(a.date);
    if (sort === 'date_asc') return new Date(a.date) - new Date(b.date);
    if (sort === 'price_asc') return a.price - b.price;
    if (sort === 'price_desc') return b.price - a.price;
    if (sort === 'name_asc') return a.name.localeCompare(b.name, 'ja');
    return 0;
  });

  // Best price per item name
  const bestPrices = {};
  items.forEach(i => {
    if (!bestPrices[i.name] || i.price < bestPrices[i.name]) bestPrices[i.name] = i.price;
  });

  // Shop filters
  const shops = [...new Set(items.map(i => i.shop))].sort();
  const fr = document.getElementById('shopFilters');
  fr.innerHTML = '';
  if (shops.length > 1) {
    const all = document.createElement('button');
    all.className = 'filter-chip' + (!activeShopFilter ? ' active' : '');
    all.textContent = 'ã™ã¹ã¦';
    all.onclick = () => { activeShopFilter = ''; renderList(); };
    fr.appendChild(all);
    shops.forEach(s => {
      const c = document.createElement('button');
      c.className = 'filter-chip' + (activeShopFilter === s ? ' active' : '');
      c.textContent = s;
      c.onclick = () => { activeShopFilter = s; renderList(); };
      fr.appendChild(c);
    });
  }

  const container = document.getElementById('listContainer');
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">${items.length === 0 ? 'ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>ã€Œç™»éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„' : 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“'}</div></div>`;
    return;
  }

  container.innerHTML = filtered.map(item => {
    const isBest = item.price === bestPrices[item.name];
    const priceStr = item.price.toLocaleString();
    const dateStr = item.date.replace(/-/g,'/');
    return `
    <div class="item-card ${isBest ? 'best-price' : ''}" onclick="openDetail('${item.id}')">
      <div class="card-top">
        <div class="card-name">${esc(item.name)}${isBest ? ' <span class="best-label">åº•å€¤</span>' : ''}</div>
        <div><span class="card-price">Â¥${priceStr}</span>${item.unit ? `<span class="card-price-unit">/${esc(item.unit)}</span>` : ''}</div>
      </div>
      <div class="card-bottom">
        <span class="tag"><span class="tag-icon">ğŸª</span>${esc(item.shop)}</span>
        <span class="tag"><span class="tag-icon">ğŸ“…</span>${dateStr}</span>
        ${item.note ? `<span class="tag"><span class="tag-icon">ğŸ“</span>${esc(item.note)}</span>` : ''}
        ${item.photo ? `<span class="tag"><span class="tag-icon">ğŸ“·</span>å†™çœŸã‚ã‚Š</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ===== DETAIL MODAL =====
function openDetail(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  currentId = id;
  document.getElementById('detailName').textContent = item.name;
  document.getElementById('detailPrice').textContent = 'Â¥' + item.price.toLocaleString();
  document.getElementById('detailUnit').textContent = item.unit || '-';
  document.getElementById('detailShop').textContent = item.shop;
  document.getElementById('detailDate').textContent = item.date.replace(/-/g,'/');
  document.getElementById('detailNote').textContent = item.note || '-';
  const detailPhotoWrap = document.getElementById('detailPhotoWrap');
  const detailPhoto = document.getElementById('detailPhoto');
  if (item.photo) {
    detailPhoto.src = item.photo;
    detailPhotoWrap.classList.remove('hidden');
  } else {
    detailPhoto.src = '';
    detailPhotoWrap.classList.add('hidden');
  }
  document.getElementById('detailOverlay').classList.add('show');
}

function closeDetail(e) {
  if (e && e.target !== document.getElementById('detailOverlay')) return;
  document.getElementById('detailOverlay').classList.remove('show');
}

function editItem() {
  const item = items.find(i => i.id === currentId);
  if (!item) return;
  document.getElementById('detailOverlay').classList.remove('show');
  document.getElementById('editId').value = item.id;
  document.getElementById('fName').value = item.name;
  document.getElementById('fShop').value = item.shop;
  document.getElementById('fPrice').value = item.price;
  document.getElementById('fUnit').value = item.unit || '';
  document.getElementById('fDate').value = item.date;
  document.getElementById('fNote').value = item.note || '';
  setPhotoPreview(item.photo || '');
  document.getElementById('formTitle').textContent = 'ç·¨é›†ã™ã‚‹';
  showTab('add');
}

function deleteItem() {
  if (!confirm('ã€Œ' + items.find(i=>i.id===currentId)?.name + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  items = items.filter(i => i.id !== currentId);
  save();
  document.getElementById('detailOverlay').classList.remove('show');
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  renderList();
}

// ===== FORM =====
function resetForm() {
  document.getElementById('editId').value = '';
  document.getElementById('fName').value = '';
  document.getElementById('fShop').value = '';
  document.getElementById('fPrice').value = '';
  document.getElementById('fUnit').value = '';
  document.getElementById('fDate').value = todayStr();
  document.getElementById('fNote').value = '';
  clearPhoto();
  document.getElementById('formTitle').textContent = 'æ–°ã—ãç™»éŒ²ã™ã‚‹';
}

function setPhotoPreview(photoDataUrl) {
  const wrap = document.getElementById('photoPreviewWrap');
  const preview = document.getElementById('photoPreview');
  if (photoDataUrl) {
    preview.src = photoDataUrl;
    wrap.classList.remove('hidden');
  } else {
    preview.src = '';
    wrap.classList.add('hidden');
  }
}

function handlePhotoChange(event) {
  const file = event.target.files[0];
  if (!file) return setPhotoPreview('');
  if (!file.type.startsWith('image/')) {
    showToast('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    event.target.value = '';
    return setPhotoPreview('');
  }
  const reader = new FileReader();
  reader.onload = ev => setPhotoPreview(ev.target.result);
  reader.readAsDataURL(file);
}

function clearPhoto() {
  document.getElementById('fPhoto').value = '';
  setPhotoPreview('');
}

function todayStr() {
  return new Date().toISOString().slice(0,10);
}

function updateShopSuggestions() {
  const shops = [...new Set(items.map(i => i.shop))];
  const dl = document.getElementById('shopSuggestions');
  dl.innerHTML = shops.map(s => `<option value="${esc(s)}">`).join('');
}

function saveItem() {
  const name = document.getElementById('fName').value.trim();
  const shop = document.getElementById('fShop').value.trim();
  const priceRaw = document.getElementById('fPrice').value;
  const price = parseFloat(priceRaw);
  const unit = document.getElementById('fUnit').value.trim();
  const date = document.getElementById('fDate').value;
  const note = document.getElementById('fNote').value.trim();
  const photo = document.getElementById('photoPreview').src || '';
  const editId = document.getElementById('editId').value;

  if (!name) return showToast('å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!shop) return showToast('åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!priceRaw || isNaN(price) || price < 0) return showToast('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!date) return showToast('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  if (editId) {
    const idx = items.findIndex(i => i.id === editId);
    if (idx >= 0) items[idx] = { id: editId, name, shop, price, unit, date, note, photo };
    showToast('æ›´æ–°ã—ã¾ã—ãŸ âœ“');
  } else {
    items.push({ id: genId(), name, shop, price, unit, date, note, photo });
    showToast('ç™»éŒ²ã—ã¾ã—ãŸ âœ“');
  }

  save();
  updateShopSuggestions();
  resetForm();
  showTab('list');
}

// ===== DATA MANAGEMENT =====
function exportData() {
  const json = JSON.stringify({ version: 1, exported: new Date().toISOString(), items }, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'åº•å€¤ãƒ¡ãƒ¢_' + todayStr() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      const imported = Array.isArray(data) ? data : (data.items || []);
      let added = 0;
      imported.forEach(item => {
        if (item.name && item.shop && item.price != null && item.date) {
          if (!items.find(i => i.id === item.id)) {
            items.push({ id: item.id || genId(), name: item.name, shop: item.shop, price: Number(item.price), unit: item.unit || '', date: item.date, note: item.note || '', photo: item.photo || '' });
            added++;
          }
        }
      });
      save();
      updateShopSuggestions();
      showToast(added + 'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
      updateStats();
    } catch {
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function clearAll() {
  if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  items = [];
  save();
  showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  renderList();
}

// ===== TOAST =====
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('fDate').value = todayStr();
  updateShopSuggestions();
  updateCount();
  updateStats();
  renderList();

  // Swipe down to close modal
  let startY = 0;
  const modal = document.querySelector('.modal');
  modal.addEventListener('touchstart', e => startY = e.touches[0].clientY, {passive:true});
  modal.addEventListener('touchend', e => {
    if (e.changedTouches[0].clientY - startY > 60) document.getElementById('detailOverlay').classList.remove('show');
  }, {passive:true});
});

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .catch(e => console.log('SW registration failed:', e));
  });
}
</script>
</body>
</html>
